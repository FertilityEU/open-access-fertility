<!DOCTYPE html>
<html>
<head>
    <title>Fertility vs Socioeconomic Conditions</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #map { height: 600px; }
        .legend { padding: 10px; background: white; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div id="map"></div>

    <script>
        // Configurazione mappa
        const map = L.map('map').setView([54.5, 15.2], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        // Dati dal CSV (solo 2019)
        const data = {
            "BG31": { fertility: 1.908, poverty: 41.6, density: 39 },
            "BG32": { fertility: 1.770, poverty: 37.6, density: 53.1 },
            // ... Aggiungi tutti gli altri dati del 2019 ...
        };

        // Scala colori fertilità
        const fertilityScale = chroma.scale(['#f7fcf0','#00441b']).domain([0.9, 2.3]);
        
        // Scala dimensioni povertà
        const povertyScale = d => Math.sqrt(d) * 5;

        // Creazione marcatori
        Object.entries(data).forEach(([code, values]) => {
            L.circleMarker([getCoordinates(code)], {
                radius: povertyScale(values.poverty),
                fillColor: fertilityScale(values.fertility),
                color: '#333',
                weight: 1,
                fillOpacity: 0.7
            }).bindPopup(`
                <b>${code}</b><br>
                Fertility: ${values.fertility}<br>
                Poverty: ${values.poverty}%<br>
                Density: ${values.density}/km²
            `).addTo(map);
        });

        // Legenda
        const legend = L.control({ position: 'bottomright' });
        legend.onAdd = () => {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<h4>Fertility Rate</h4>';
            for (let i = 0.9; i <= 2.3; i += 0.3) {
                div.innerHTML += `
                    <div style="background:${fertilityScale(i)}"> 
                    ${i.toFixed(1)}</div>
                `;
            }
            div.innerHTML += '<h4>Poverty (size)</h4>';
            return div;
        };
        legend.addTo(map);

        // Funzione coordinate fittizia - sostituire con geocodifica reale
        function getCoordinates(code) {
            // Implementa la geocodifica reale delle coordinate NUTS2
            return [Math.random() * 10 + 45, Math.random() * 15 + 5];
        }
    </script>
    
    <!-- Aggiungi queste librerie per le scale di colore -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.2/chroma.min.js"></script>
</body>
</html>